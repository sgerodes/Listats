<!doctype html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<script>
    let go_message = ["depth 5", "movetime 1000", "infinite"][1];
    let worker_cubicle = [];
    let worker_output = [];
    let worker_count = 0;
    let centipawn_search_token = "score cp ";

    let centipawns = [];
    let all_fens = null;
    let centipawn_diff = [];

    function create_sf_worker(fen) {
        let worker_number = worker_count;
        let stockfish = new Worker("./node_modules/stockfish/src/stockfish.js");
        worker_cubicle.push(stockfish);
        worker_output.push([fen]);
        centipawns.push(0);
        centipawn_diff.push(0);
        stockfish.postMessage("position fen '" + fen + "' ");
        stockfish.postMessage("go " + go_message);
        stockfish.onmessage = function (event) {
            let msg = event.data ? event.data : event;
            worker_output[worker_number].push(msg);
            let cp = extract_value(msg, centipawn_search_token);
            if (cp) {
                centipawns[worker_number] = parseInt(cp);
                centipawn_diff[worker_number] = centipawns[worker_number] - centipawns[0];
            }
        };
        worker_count++;
    }

    function extract_value(msg, searched_string) {
        let value_index = msg.indexOf(searched_string);
        if (value_index === -1) {
            return null;
        }

        value_index += searched_string.length;
        let value_index_end = msg.indexOf(" ", value_index);
        //console.log(msg);
        //console.log(value_index, value_index_end === -1 ? msg.length : value_index_end);
        return msg.substring(value_index, value_index_end === -1 ? msg.length : value_index_end);
    }

    function get_without_every_piece(fen) {
        let fens = [];
        for (let i = 0; i < fen.indexOf(" "); ++i) {
            if (isNaN(fen[i])) {
                if (fen[i] !== "/" && fen[i].toLowerCase() !== "k") {
                    fens.push(subtituteOnePiece(fen, i));
                }
            }
        }
        return fens;
    }

    function subtituteOnePiece(fen, index) {
        function isNumeric(str) {
            return !isNaN(str);
        }

        let isLeftNumber = isNumeric(fen[index - 1]);
        let isRightNumber = isNumeric(fen[index + 1]);
        let leftIndex = isLeftNumber ? index - 1 : index;
        let rightIndex = isRightNumber ? index + 1 : index;
        let left = isLeftNumber ? parseInt(fen[index - 1]) : 0;
        let right = isRightNumber ? parseInt(fen[index + 1]) : 0;
        let leftSub = fen.substring(0, leftIndex);
        let rightSub = fen.substring(rightIndex + 1);
        return leftSub + (left + right + 1) + rightSub;
    }

    function create_worker_for_every_position() {
        //let initialFen = "2p5/8/k2Q4/8/8/8/8/4K3 w KQkq - 0 1";
        let initialFen = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";

        create_sf_worker(initialFen);
        all_fens = get_without_every_piece(initialFen);
        console.log(all_fens);
        for (let fen of all_fens) {
            create_sf_worker(fen);
        }
    }


    create_worker_for_every_position();



    function log_table() {
        console.table([centipawns, centipawn_diff]);
    }
    setInterval(log_table, 1000);


</script>
</body>
</html>

